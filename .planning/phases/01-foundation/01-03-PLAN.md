---
phase: 01-foundation
plan: 03
type: execute
---

<objective>
Design and create database schema for accounts, transactions, categories, and budgets with Row Level Security.

Purpose: Establish the data model that supports all financial tracking features.
Output: Supabase database with complete schema, RLS policies, and generated TypeScript types.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

**Depends on:** 01-02 (Auth flow - users exist)

**CSV data analysis (from pluggy-accounts-data.csv):**
Key fields identified for import:
- accountId (UUID)
- transactions.id (UUID)
- transactions.description, transactions.descriptionRaw
- transactions.amount (negative = debit, positive = credit)
- transactions.date (ISO timestamp)
- transactions.category, transactions.categoryId
- transactions.type (DEBIT/CREDIT)
- transactions.paymentData.paymentMethod (PIX, CARTAO, OTHER)
- transactions.paymentData.receiver/payer.name

**Schema design principles:**
- All tables user-scoped via user_id foreign key
- RLS policies enforce user isolation
- Categories: mix of default system categories + user custom
- Budgets: monthly envelope-style with category allocation
- Transactions: support both imported and manual entry

**Currency:**
- BRL (Brazilian Real)
- Store amounts as integer cents (avoid floating point)
- Display with R$ format

**Discovery findings (Level 1):**
- RLS policy pattern: `(select auth.uid()) = user_id`
- Use security definer functions for complex policies if needed
- Enable RLS on every table with user data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core database schema</name>
  <files>supabase/migrations/001_initial_schema.sql</files>
  <action>
    Initialize Supabase CLI if not present: `npx supabase init`

    Create migration file `supabase/migrations/001_initial_schema.sql` with:

    **accounts table:**
    ```sql
    create table public.accounts (
      id uuid primary key default gen_random_uuid(),
      user_id uuid references auth.users(id) on delete cascade not null,
      name text not null,
      type text not null check (type in ('checking', 'savings', 'credit_card', 'investment', 'cash')),
      institution text, -- bank name
      balance_cents bigint not null default 0, -- current balance in cents
      currency text not null default 'BRL',
      color text, -- for UI display
      icon text, -- for UI display
      is_active boolean not null default true,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );
    ```

    **categories table:**
    ```sql
    create table public.categories (
      id uuid primary key default gen_random_uuid(),
      user_id uuid references auth.users(id) on delete cascade, -- null for system categories
      name text not null,
      icon text,
      color text,
      parent_id uuid references public.categories(id), -- for subcategories
      is_system boolean not null default false, -- true for default categories
      is_income boolean not null default false, -- income vs expense category
      created_at timestamptz not null default now()
    );
    ```

    **transactions table:**
    ```sql
    create table public.transactions (
      id uuid primary key default gen_random_uuid(),
      user_id uuid references auth.users(id) on delete cascade not null,
      account_id uuid references public.accounts(id) on delete cascade not null,
      category_id uuid references public.categories(id),
      amount_cents bigint not null, -- positive = income, negative = expense
      description text not null,
      description_raw text, -- original from import
      date date not null,
      type text not null check (type in ('income', 'expense', 'transfer')),
      payment_method text, -- PIX, CARTAO, BOLETO, etc
      is_recurring boolean not null default false,
      recurring_id uuid, -- links recurring transactions
      import_id text, -- original ID from CSV import
      notes text,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );
    ```

    **budgets table (envelope style):**
    ```sql
    create table public.budgets (
      id uuid primary key default gen_random_uuid(),
      user_id uuid references auth.users(id) on delete cascade not null,
      category_id uuid references public.categories(id) not null,
      month date not null, -- first day of month (2024-01-01)
      allocated_cents bigint not null default 0, -- budgeted amount
      rollover_cents bigint not null default 0, -- carried from previous month
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now(),
      unique(user_id, category_id, month)
    );
    ```

    **Add indexes:**
    ```sql
    create index idx_transactions_user_date on public.transactions(user_id, date desc);
    create index idx_transactions_account on public.transactions(account_id);
    create index idx_transactions_category on public.transactions(category_id);
    create index idx_budgets_user_month on public.budgets(user_id, month);
    create index idx_accounts_user on public.accounts(user_id);
    ```

    **Add updated_at trigger:**
    ```sql
    create or replace function public.update_updated_at()
    returns trigger as $$
    begin
      new.updated_at = now();
      return new;
    end;
    $$ language plpgsql;

    create trigger accounts_updated_at before update on public.accounts
      for each row execute function public.update_updated_at();
    create trigger transactions_updated_at before update on public.transactions
      for each row execute function public.update_updated_at();
    create trigger budgets_updated_at before update on public.budgets
      for each row execute function public.update_updated_at();
    ```
  </action>
  <verify>
    - Migration file exists at `supabase/migrations/001_initial_schema.sql`
    - SQL syntax is valid (no errors when applied)
  </verify>
  <done>Core schema created with accounts, categories, transactions, and budgets tables</done>
</task>

<task type="auto">
  <name>Task 2: Add Row Level Security policies</name>
  <files>supabase/migrations/002_rls_policies.sql</files>
  <action>
    Create migration file `supabase/migrations/002_rls_policies.sql`:

    **Enable RLS on all tables:**
    ```sql
    alter table public.accounts enable row level security;
    alter table public.categories enable row level security;
    alter table public.transactions enable row level security;
    alter table public.budgets enable row level security;
    ```

    **Accounts policies (user owns their accounts):**
    ```sql
    create policy "Users can view own accounts"
      on public.accounts for select
      to authenticated
      using ((select auth.uid()) = user_id);

    create policy "Users can create own accounts"
      on public.accounts for insert
      to authenticated
      with check ((select auth.uid()) = user_id);

    create policy "Users can update own accounts"
      on public.accounts for update
      to authenticated
      using ((select auth.uid()) = user_id);

    create policy "Users can delete own accounts"
      on public.accounts for delete
      to authenticated
      using ((select auth.uid()) = user_id);
    ```

    **Categories policies (user owns OR system category):**
    ```sql
    create policy "Users can view own and system categories"
      on public.categories for select
      to authenticated
      using (
        user_id is null -- system categories
        or (select auth.uid()) = user_id -- own categories
      );

    create policy "Users can create own categories"
      on public.categories for insert
      to authenticated
      with check ((select auth.uid()) = user_id and is_system = false);

    create policy "Users can update own categories"
      on public.categories for update
      to authenticated
      using ((select auth.uid()) = user_id and is_system = false);

    create policy "Users can delete own categories"
      on public.categories for delete
      to authenticated
      using ((select auth.uid()) = user_id and is_system = false);
    ```

    **Transactions policies:**
    ```sql
    create policy "Users can view own transactions"
      on public.transactions for select
      to authenticated
      using ((select auth.uid()) = user_id);

    create policy "Users can create own transactions"
      on public.transactions for insert
      to authenticated
      with check ((select auth.uid()) = user_id);

    create policy "Users can update own transactions"
      on public.transactions for update
      to authenticated
      using ((select auth.uid()) = user_id);

    create policy "Users can delete own transactions"
      on public.transactions for delete
      to authenticated
      using ((select auth.uid()) = user_id);
    ```

    **Budgets policies:**
    ```sql
    create policy "Users can view own budgets"
      on public.budgets for select
      to authenticated
      using ((select auth.uid()) = user_id);

    create policy "Users can create own budgets"
      on public.budgets for insert
      to authenticated
      with check ((select auth.uid()) = user_id);

    create policy "Users can update own budgets"
      on public.budgets for update
      to authenticated
      using ((select auth.uid()) = user_id);

    create policy "Users can delete own budgets"
      on public.budgets for delete
      to authenticated
      using ((select auth.uid()) = user_id);
    ```
  </action>
  <verify>
    - Migration file exists at `supabase/migrations/002_rls_policies.sql`
    - SQL syntax is valid
  </verify>
  <done>RLS policies created for all tables, enforcing user data isolation</done>
</task>

<task type="auto">
  <name>Task 3: Seed default categories and generate TypeScript types</name>
  <files>supabase/migrations/003_seed_categories.sql, src/lib/database.types.ts</files>
  <action>
    Create migration `supabase/migrations/003_seed_categories.sql` with default categories:

    ```sql
    -- Income categories (is_income = true)
    insert into public.categories (name, icon, color, is_system, is_income) values
      ('Salary', 'briefcase', '#22c55e', true, true),
      ('Freelance', 'laptop', '#22c55e', true, true),
      ('Investments', 'trending-up', '#22c55e', true, true),
      ('Gifts', 'gift', '#22c55e', true, true),
      ('Other Income', 'plus-circle', '#22c55e', true, true);

    -- Expense categories (is_income = false)
    insert into public.categories (name, icon, color, is_system, is_income) values
      ('Housing', 'home', '#ef4444', true, false),
      ('Transportation', 'car', '#f97316', true, false),
      ('Food & Dining', 'utensils', '#eab308', true, false),
      ('Groceries', 'shopping-cart', '#84cc16', true, false),
      ('Utilities', 'zap', '#06b6d4', true, false),
      ('Healthcare', 'heart', '#ec4899', true, false),
      ('Entertainment', 'tv', '#8b5cf6', true, false),
      ('Shopping', 'shopping-bag', '#f43f5e', true, false),
      ('Education', 'book-open', '#3b82f6', true, false),
      ('Personal Care', 'smile', '#14b8a6', true, false),
      ('Subscriptions', 'repeat', '#a855f7', true, false),
      ('Travel', 'plane', '#0ea5e9', true, false),
      ('Transfers', 'arrow-right-left', '#6b7280', true, false),
      ('Other Expenses', 'more-horizontal', '#6b7280', true, false);
    ```

    Generate TypeScript types using Supabase MCP tool or CLI.

    If using MCP: Call `mcp__supabase__generate_typescript_types` tool

    If using CLI (after linking project):
    ```bash
    npx supabase gen types typescript --linked > src/lib/database.types.ts
    ```

    Create `src/lib/supabase/types.ts` to re-export and add helpers:
    ```typescript
    export type { Database } from '../database.types'

    import type { Database } from '../database.types'

    export type Account = Database['public']['Tables']['accounts']['Row']
    export type Category = Database['public']['Tables']['categories']['Row']
    export type Transaction = Database['public']['Tables']['transactions']['Row']
    export type Budget = Database['public']['Tables']['budgets']['Row']

    // Insert types for creating records
    export type NewAccount = Database['public']['Tables']['accounts']['Insert']
    export type NewCategory = Database['public']['Tables']['categories']['Insert']
    export type NewTransaction = Database['public']['Tables']['transactions']['Insert']
    export type NewBudget = Database['public']['Tables']['budgets']['Insert']
    ```

    Note: Migrations will be applied when the Supabase project is linked. For local development, use `npx supabase db push` or apply via dashboard.
  </action>
  <verify>
    - Migration files exist in `supabase/migrations/`
    - TypeScript types file exists at `src/lib/database.types.ts` or `src/lib/supabase/types.ts`
    - `npm run build` succeeds
  </verify>
  <done>Default categories seeded, TypeScript types generated for database schema</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All migration files created in `supabase/migrations/`
- [ ] Schema includes: accounts, categories, transactions, budgets
- [ ] RLS enabled on all user-data tables
- [ ] RLS policies allow only owner access (or system categories)
- [ ] Default categories seeded (income + expense)
- [ ] TypeScript types generated
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- Complete database schema for financial app
- All tables have appropriate indexes
- RLS policies enforce user data isolation
- Default categories available for all users
- TypeScript types ready for use in app code
- Schema supports CSV import, manual entry, and budgeting features
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`:

# Phase 1 Plan 3: Database Schema Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 1 complete. Ready for Phase 2: Accounts & Transactions
</output>
