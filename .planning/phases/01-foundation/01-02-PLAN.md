---
phase: 01-foundation
plan: 02
type: execute
---

<objective>
Implement Supabase authentication flow with login, signup, and protected routes.

Purpose: Enable user authentication so all app data can be user-scoped and secure.
Output: Working auth flow with email/password login, signup, logout, and middleware protecting app routes.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Depends on:** 01-01 (Project setup with Supabase clients)

**Discovery findings (Level 1 verification):**
- Use `@supabase/ssr` with `createServerClient` for server components
- Middleware MUST call `supabase.auth.getUser()` to refresh tokens
- Critical: Do NOT add code between `createServerClient` and `getUser()` call
- Use `getAll`/`setAll` cookie pattern (NOT deprecated `get`/`set`/`remove`)
- OAuth callback route needed at `/auth/callback`

**Auth approach:**
- Email/password authentication (simple, works for personal finance app)
- No OAuth providers for v1 (can add later)
- Protected routes via middleware
- Server actions for auth operations (not API routes)

**Prior decisions:**
- Supabase for backend (cloud-hosted, auth included)
- Single user app (no multi-user sharing)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth middleware for protected routes</name>
  <files>src/middleware.ts, src/lib/supabase/middleware.ts</files>
  <action>
    Create `src/lib/supabase/middleware.ts` with `updateSession` function:
    - Create Supabase client with request/response cookie handling
    - Use `getAll`/`setAll` pattern for cookies
    - Call `supabase.auth.getUser()` to refresh session
    - CRITICAL: No code between client creation and getUser() call
    - Return the response with updated cookies

    Create `src/middleware.ts`:
    - Import and call `updateSession`
    - Add matcher to exclude static files, images, favicon
    - Redirect unauthenticated users to /login (except /login, /signup, /auth paths)

    Matcher pattern:
    ```typescript
    export const config = {
      matcher: [
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
      ],
    }
    ```
  </action>
  <verify>
    - `npm run build` succeeds
    - No TypeScript errors in middleware files
  </verify>
  <done>Middleware configured to refresh auth tokens and protect routes</done>
</task>

<task type="auto">
  <name>Task 2: Create auth UI pages and server actions</name>
  <files>src/app/login/page.tsx, src/app/signup/page.tsx, src/app/auth/callback/route.ts, src/lib/actions/auth.ts</files>
  <action>
    Create server actions in `src/lib/actions/auth.ts`:
    - `signIn(formData)` - Email/password login, redirect to / on success
    - `signUp(formData)` - Create account, redirect to / on success
    - `signOut()` - Logout, redirect to /login
    - Use `createClient()` from server.ts
    - Use `redirect()` from next/navigation (NOT router)
    - Handle errors gracefully, return error messages

    Create `src/app/login/page.tsx`:
    - Server component with form
    - Email and password inputs using shadcn Input component
    - Submit button using shadcn Button
    - Link to signup page
    - Display error messages from server action
    - Clean, centered card layout (Nubank-inspired)
    - Use `useActionState` or form action pattern

    Create `src/app/signup/page.tsx`:
    - Similar to login page
    - Email, password, confirm password fields
    - Link back to login
    - Same clean design

    Create `src/app/auth/callback/route.ts`:
    - Handle OAuth callback (for future use)
    - Exchange code for session
    - Redirect to home

    Design notes:
    - Centered card on page
    - Generous whitespace
    - Clear error messages below form
    - "Budget" logo/title at top
  </action>
  <verify>
    - `npm run build` succeeds
    - Login and signup pages render at /login and /signup
    - No TypeScript errors
  </verify>
  <done>Auth pages created with server actions for login, signup, logout</done>
</task>

<task type="auto">
  <name>Task 3: Integrate auth into app shell</name>
  <files>src/components/layout/header.tsx, src/components/layout/user-menu.tsx, src/app/page.tsx, src/app/(authenticated)/layout.tsx</files>
  <action>
    Create route groups for authenticated vs public pages:
    - Move main app content to `src/app/(authenticated)/` route group
    - Create `src/app/(authenticated)/layout.tsx` with header and sidebar
    - Keep login/signup at root level (public)

    Create `src/components/layout/user-menu.tsx`:
    - Display user email (from session)
    - Dropdown with "Sign out" option
    - Use shadcn DropdownMenu component (add if needed: `npx shadcn@latest add dropdown-menu avatar`)

    Update `src/components/layout/header.tsx`:
    - Include UserMenu component on right side
    - Pass user data from server component

    Update `src/app/(authenticated)/page.tsx` (was src/app/page.tsx):
    - Move existing home content here
    - Display "Welcome, {email}" message
    - Protected by middleware

    Ensure middleware redirects:
    - Unauthenticated users hitting / → /login
    - Authenticated users hitting /login → /
  </action>
  <verify>
    - `npm run build` succeeds
    - Unauthenticated: visiting / redirects to /login
    - Can access /login and /signup without auth
  </verify>
  <done>Auth integrated into app shell, route groups organized, user menu displays</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow with Supabase: login, signup, logout, protected routes</what-built>
  <how-to-verify>
    1. Create a test Supabase project (or use existing):
       - Go to supabase.com and create a free project
       - Copy URL and anon key to `.env.local`
    2. Run: `npm run dev`
    3. Test unauthenticated flow:
       - Visit http://localhost:3000 → should redirect to /login
       - Login page shows clean form with email/password
    4. Test signup:
       - Click "Sign up" link
       - Enter email and password
       - Submit → should create account and redirect to home
       - (Check Supabase dashboard > Authentication > Users to confirm)
    5. Test authenticated state:
       - Home page shows welcome message
       - Header shows user email with dropdown
       - Sidebar navigation visible
    6. Test logout:
       - Click user menu → Sign out
       - Should redirect to /login
       - Visiting / again redirects to /login
    7. Test login:
       - Enter credentials → logs in and redirects to home
  </how-to-verify>
  <resume-signal>Type "approved" to continue to database schema plan, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Middleware protects authenticated routes
- [ ] Login page renders and submits correctly
- [ ] Signup creates new users in Supabase
- [ ] Logout clears session and redirects
- [ ] User menu shows current user
</verification>

<success_criteria>
- Email/password authentication working end-to-end
- Protected routes redirect unauthenticated users to /login
- Login, signup, logout all functional
- User menu displays email and logout option
- Clean, minimal auth UI matching design direction
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`:

# Phase 1 Plan 2: Auth Flow Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 01-03-PLAN.md (Database schema)
</output>
